# БИТ.Управление производительностью (скрипты настройки сбора счетчиков)

![Platform](https://img.shields.io/badge/-Linux-green)
![Platform](https://img.shields.io/badge/-win--32%7C64-lightgrey)
[![GitHub release (latest SemVer)](https://img.shields.io/github/v/release/Shanginre/BIT-PerfManager-Setup)](https://github.com/Shanginre/BIT-PerfManager-Setup/releases)

Инструкция настройки сбора счетчиков производительности с серверов для продуктов линейки "БИТ:Управление производительностью".


## Инструкция настройки для Windows

#### Шаг 1. Откройте командную оболочку cmd с правами администратора. 

#### Шаг 2. Перейдите в папку, где находится текущий файл readme.txt, выполнив команду:
```console
cd полный_адрес_папки_со_скриптом_на_диске
```

#### Шаг 3. Запустите скрипт powershell "setup_monitoring.ps1" выполнив команду:
```console
powershell -File "setup_monitoring.ps1" -server_type xxxx [-1C_version 8.x.xx.xxxx] [-1C_cluster_port хххх] [-1C_RAS_port хххх] [-1C_ClusterFolder хххх] [-share_user хххх]
```
Состав параметров скрипта зависит от роли сервера, на котором инсталлируется сбор счетчиков:
- **server_type** - имя роли сервера (можно указывать несколько через символ \_). Доступны следующие имена ролей:
   - *1C* - на сервере работает только служба сервера 1С.
   - *MSSQL* - на сервере работает только служба MSSQL
   - *Postgree* - на сервере работает только служба Postgree
   - *1C_MSSQL* - на сервере работает служба 1C и служба MSSQL
   - *1C_Postgree* - на сервере работает служба 1C и служба Postgree
   - *other* - на сервере не работают служба 1С и службы СУБД.
- **1C_version** - версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ, к которому будет подключен RAS.
   - Параметр указывается только для ролей сервера "1C", "1C_MSSQL" или "1C_Postgree".
- **1C_cluster_port** - порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ, к которому будет подключен RAS.
   - Если порт службы 1С стандартный 1540, то данный параметр можно не указывать.
   - Параметр указывается только для ролей сервера "1C", "1C_MSSQL" или "1C_Postgree". 
- **1C_RAS_port** - порт агента RAS, к которому будет обращаться система мониторинга.
   - Если параметр не указан, то назначается порт агента RAS по умолчанию 1545.
   - Параметр указывается только для ролей сервера "1C", "1C_MSSQL" или "1C_Postgree".
- **1C_ClusterFolder** - имя каталога данных кластера 1С, который содержит в себе сеансовые данные кластера, 
      а также индекс полнотекстового поиска и журнал регистрации информационных баз,
      которые зарегистрированы в данном кластере.
   - Если расположение каталога не переопределено в параметрах запуска службы 1С, то 
      параметр можно не указывать. В данном случае адрес директории будет C:\Program Files\1cv8\srvinfo.
      Параметр указывается только для ролей сервера "1C", "1C_MSSQL" или "1C_Postgree". 
- **share_user** - имя пользователя, для которого будут открыты сетевые папки с логами.
   - Имя пользователя должно совпадать с именем пользователя, под которым работает служба 1С, где размещена база мониторинга "БИТ.Управление производительностью".
   - Если требуется открыть папки для всех пользоветелей, то нужно указать значение everyone.
   - В некоторых случаях не удается программно открыть сетевой доступ к папкам. Рекомендуется вручную проверить настройки доступа сетевых папок.

#### Примеры:
```console
powershell -File "make_monitoring_settings.ps1" -server_type 1C_MSSQL -1C_version 8.3.24.1667 -share_user everyone

```
- роли сервера: сервер приложений 1С и сервер СУБД MSSQL
- версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 8.3.24.1667
- порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 1540 (стандартный)
- порт агента RAS: 1545 (стандартный)
- адрес каталога данных кластера 1С: C:\Program Files\1cv8\srvinfo (стандартный)
- имя пользователя, которому открыты сетевые папки с логами: everyone (все пользователи)

```console
powershell -File "make_monitoring_settings.ps1" -server_type 1C -1C_version 8.3.24.1667 -1C_cluster_port 2540 -1C_RAS_port 2545 -1C_ClusterFolder "D:\1cv8\srvinfo" -share_user admin

```
- роли сервера: сервер приложений 1С
- версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 8.3.24.1667
- порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 2540
- порт агента RAS: 2545
- адрес каталога данных кластера 1С: D:\1cv8\srvinfo
- имя пользователя, которому открыты сетевые папки с логами: admin

```console
powershell -File "make_monitoring_settings.ps1" -server_type MSSQL -share_user admin

```
- роли сервера: сервер СУБД MSSQL
- имя пользователя, которому открыты сетевые папки с логами: admin


## Инструкция настройки для Linux

#### Шаг 1. Откройте командную оболочку. 

#### Шаг 2. Перейдите в папку, где находится текущий файл readme.txt, выполнив команду:
```console
cd полный_адрес_папки_со_скриптом_на_диске
```

#### Шаг 3. Запустите скрипт setup_monitoring.sh с параметрами:
```console
sudo bash setup_monitoring.sh --server-type=xxxx 
      [--1c-version=8.x.xx.xxxx] [--1c-cluster-port=хххх] [--1c-ras-port=хххх] [--1c-cluster-folder=хххх] [--share-user=хххх]
```
Состав параметров скрипта зависит от роли сервера, на котором инсталлируется сбор счетчиков:
- **--server-type** - имя роли сервера (можно указывать несколько через символ \_). Доступны следующие имена ролей:
   - *1C* - на сервере работает только служба сервера 1С.
   - *PostgreSQL* - на сервере работает только служба PostgreSQL
   - *1C_PostgreSQL* - на сервере работает служба 1C и служба PostgreSQL
   - *other* - на сервере не работают служба 1С и службы СУБД.
- **--1c-version** - версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ, к которому будет подключен RAS.
   - Параметр указывается только для ролей сервера "1C" или "1C_PostgreSQL".
- **--1c-cluster-port** - порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ, к которому будет подключен RAS.
   - Если порт службы 1С стандартный 1540, то данный параметр можно не указывать.
   - Параметр указывается только для ролей сервера "1C" или "1C_PostgreSQL". 
- **--1c-ras-port** - порт агента RAS, к которому будет обращаться система мониторинга.
   - Если параметр не указан, то назначается порт агента RAS по умолчанию 1545.
   - Параметр указывается только для ролей сервера "1C" или "1C_PostgreSQL".
- **--1c-cluster-folder** - имя каталога данных кластера 1С, который содержит в себе сеансовые данные кластера, 
      а также индекс полнотекстового поиска и журнал регистрации информационных баз,
      которые зарегистрированы в данном кластере.
   - Если расположение каталога не переопределено в параметрах запуска службы 1С, то 
      параметр можно не указывать. В данном случае адрес директории будет /home/usr1cv8/.1cv8/1C/1cv8.
      Параметр указывается только для ролей сервера "1C" или "1C_PostgreSQL". 
- **--share-user** - имя пользователя, для которого будут открыты сетевые папки с логами.
   - Имя пользователя должно совпадать с именем пользователя, под которым работает служба 1С, где размещена база мониторинга "БИТ.Управление производительностью".
   - В некоторых случаях не удается программно открыть сетевой доступ к папкам. Рекомендуется вручную проверить настройки доступа сетевых папок:
      - /var/log/bit_monitoring/server_counters_logs
      - /var/log/bit_monitoring/1C_tech_logs (только для ролей сервера "1C" или "1C_PostgreSQL")
      - /var/log/bit_monitoring/cluster_folders_sizes_logs (только для ролей сервера "1C" или "1C_PostgreSQL")

#### Примеры:
```console
sudo bash setup_monitoring.sh --server-type=1C_PostgreSQL --1c-version=8.3.24.1667 --share-user=admin

```
- роли сервера: сервер приложений 1С и сервер СУБД PostgreSQL
- версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 8.3.24.1667
- порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 1540 (стандартный)
- порт агента RAS: 1545 (стандартный)
- адрес каталога данных кластера 1С: /home/usr1cv8/.1cv8/1C/1cv8 (стандартный)
- имя пользователя, которому открыты сетевые папки с логами: admin

```console
sudo bash setup_monitoring.sh --server-type=1C --1c-version=8.3.24.1667 --1c-cluster-port=2540 --1c-ras-port=2545 --1c-cluster-folder="/var/1cv8/srvinfo" -share_user admin

```
- роли сервера: сервер приложений 1С
- версия платформы кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 8.3.24.1667
- порт кластера кластера 1С, который ТРЕБУЕТСЯ МОНИТОРИТЬ: 2540
- порт агента RAS: 2545
- адрес каталога данных кластера 1С: /var/1cv8/srvinfo
- имя пользователя, которому открыты сетевые папки с логами: admin

```console
sudo bash setup_monitoring.sh --server-type=PostgreSQL -share_user admin

```
- роли сервера: сервер СУБД PostgreSQL
- имя пользователя, которому открыты сетевые папки с логами: admin